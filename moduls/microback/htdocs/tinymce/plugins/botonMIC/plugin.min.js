tinymce.PluginManager.add("botonMIC", function(a, b) {
    a.addButton("botonMIC", {
        //text: "Boton MIC",
        tooltip: "Introducir boton MIC",
        icon: 'fa fa-adjust',
		image: tinymce.baseURL + '/plugins/botonMIC/iconoBotonMIC.png', 
		stateSelector: "a[class=\"imc-bt imc-bt-especial\"]",
		init: function() {
			alert("llega");
		},
		onclick: function() {
			var v = a.selection/*,
				w = a.dom*/;
				
			var valorTexto = '',
				valorDescripcion = '',
				valorURL = '',
				valorIcono = '';
			/** Miramos si existe el nodo seleccionado. **/	
			var elementoSeleccionado = null;
			if (v.getNode() != null && v.getNode().classList.contains('imc-bt-especial')) {
				elementoSeleccionado = v.getNode();
			}
			if (v.getNode() != null && v.getNode().parentElement.classList.contains('imc-bt-especial')) {
				elementoSeleccionado = v.getNode().parentElement;
			}
			
			/** Si existe, extraemos valores posibles. **/
			if (elementoSeleccionado != null) {
				var span = elementoSeleccionado.getElementsByTagName("span");
				if (span != null && span.length > 0) {
					valorTexto  = span[0].innerText;
				}
				var strong = elementoSeleccionado.getElementsByTagName("strong");
				if (strong != null && strong.length > 0) {
					valorDescripcion  = strong[0].innerText;
				}
				var href = elementoSeleccionado.getAttribute("href");
				if (href != null) {
					valorURL = href;
				}
				
				if (elementoSeleccionado.style != null && elementoSeleccionado.style.backgroundImage != null && elementoSeleccionado.style.backgroundImage != '') {
					valorIcono = elementoSeleccionado.style.backgroundImage;
					valorIcono = valorIcono.replace("url(\"","");
					valorIcono = valorIcono.replace("\")","");
				}
				
			}
			a.windowManager.open({
                title: "Boton MIC",
                body: [{
                    type: "textbox",
                    name: "texto",
                    label: "Text:",
					value: valorTexto
                }, {
                    type: "textbox",
                    name: "descripcion",
                    label: "Descripcio:",
					value: valorDescripcion
                },{
                    type: "textbox",
                    name: "url",
                    label: "URL:",
					value: valorURL
                }, {
                    type: "textbox",
                    name: "icono",
                    label: "Icona:",
					value: valorIcono
                }],
				buttons: [{
					text: 'Borrar',
					id: 'button-borrar',
					style: 'background-color:#F99;border:black 1px solid;position:absolute;left:10px;top:10px;right:20px;margin-rigth:20px',
					onclick: function( e ) {
						//borrar
						var elementoSeleccionado = null;
						if (v.getNode() != null && v.getNode().classList.contains('imc-bt-especial')) {
							elementoSeleccionado = v.getNode();
						}
						if (v.getNode() != null && v.getNode().parentElement.classList.contains('imc-bt-especial')) {
							elementoSeleccionado = v.getNode().parentElement;
						}
						
						/** Si no existe, anyadimos la info. **/
						if (elementoSeleccionado == null) {
							alert("No hi ha bot√≥ seleccionat per esborrar.");
						} else {
							elementoSeleccionado.parentElement.removeChild(elementoSeleccionado);
						}
						tinymce.activeEditor.windowManager.close();
					},
				}, {
					text: 'Cancel',
					id: 'button-cancel',
					onclick: 'close'
				}, {
					text: 'Insert',
					id: 'button-insert',
					onclick: 'submit'
				}],
                onsubmit: function(b) {
                    
					var elementoSeleccionado = null;
					if (v.getNode() != null && v.getNode().classList.contains('imc-bt-especial')) {
						elementoSeleccionado = v.getNode();
					}
					if (v.getNode() != null && v.getNode().parentElement.classList.contains('imc-bt-especial')) {
						elementoSeleccionado = v.getNode().parentElement;
					}
					
					/** Si no existe, anyadimos la info. **/
					if (elementoSeleccionado == null) {
					
						var contenido = '';
						//ETIQUETA A
						contenido += "<a class=\"imc-bt imc-bt-especial\" ";
						
						if (b.data.url != null && b.data.url != '') {
							contenido += " href=\""+b.data.url+"\" "; 
						} 
						
						if (b.data.icono != null && b.data.icono != '') {
							contenido += " style=\"background-image: url("+b.data.icono+")\" "; 
						}
						contenido += " > ";
						
						//ETIQUETA STRONG
						if (b.data.texto != null && b.data.texto != '') {
							contenido += "<strong>"+b.data.texto+"</strong>";
						}
						
						//ETIQUETA SPAN
						if (b.data.descripcion != null && b.data.descripcion != '') {
							contenido += "<span>"+b.data.descripcion+"</span>";
						}
						
						//FIN ETIQUETA
						contenido += "</a>";
						a.insertContent(contenido);
						a.insertContent("&nbsp;");
						a.insertContent("&nbsp;");
						a.insertContent("&nbsp;");
						a.insertContent("&nbsp;");
						a.insertContent("&nbsp;");
						a.insertContent("&nbsp;");
					} else {
						
						//Seteamos el href
						if (b.data.url != null && b.data.url != '') {
							elementoSeleccionado.setAttribute("href", b.data.url);
						} else {
							elementoSeleccionado.setAttribute("href", '');
						}
						
						
						if (b.data.icono != null && b.data.icono != '') {
							elementoSeleccionado.style.backgroundImage = "url("+b.data.icono+")"; 
						} else {
							elementoSeleccionado.style.backgroundImage = '';
						}
						contenido += " > ";
						
						//ETIQUETA STRONG
						if (b.data.texto != null && b.data.texto != '') {
							if (elementoSeleccionado.getElementsByTagName("strong").length > 0) {
								elementoSeleccionado.getElementsByTagName("strong")[0].innerText =  b.data.texto;
							} else {
								var strong = document.createElement("strong");
								strong.innerText  =  b.data.texto;
								elementoSeleccionado.appendChild(strong);
							}
						} else {
							if (elementoSeleccionado.getElementsByTagName("strong").length > 0) {
								elementoSeleccionado.getElementsByTagName("strong")[0].innerText =  '';
							} else {
								var strong = document.createElement("strong");
								strong.innerText  =  '';
								elementoSeleccionado.appendChild(strong);
							}
						}
						
						//ETIQUETA SPAN
						if (b.data.descripcion != null && b.data.descripcion != '') {
							if (elementoSeleccionado.getElementsByTagName("span").length > 0) {
								elementoSeleccionado.getElementsByTagName("span")[0].innerText =  b.data.descripcion;
							} else {
								var span = document.createElement("span");
								span.innerText  =  b.data.descripcion;
								elementoSeleccionado.appendChild(span);
							}
						} else {
							if (elementoSeleccionado.getElementsByTagName("span").length > 0) {
								elementoSeleccionado.getElementsByTagName("span")[0].innerText =  '';
							} else {
								var span = document.createElement("span");
								span.innerText  =  '';
								elementoSeleccionado.appendChild(span);
							}
						}
						
					}
                } 
                
            })
        }
    })/* Necesario si lo quiere poner como menu. 
	  , a.addMenuItem("botonMIC", {
        text: "Boton MIC",
        context: "tools",
        onclick: function() {
            a.windowManager.open({
                title: "TinyMCE site",
                url: b + "/dialog.html",
                width: 600,
                height: 400,
                buttons: [{
                    text: "Insert",
                    onclick: function() {
                        var b = a.windowManager.getWindows()[0];
                        a.insertContent(b.getContentWindow().document.getElementById("content").value), b.close()
                    }
                }, {
                    text: "Close",
                    onclick: "close"
                }]
            })
        }
    })*/
});